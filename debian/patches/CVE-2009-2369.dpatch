#! /bin/sh /usr/share/dpatch/dpatch-run
## CVE-2009-2369.dpatch by Giuseppe Iuculano <giuseppe@iuculano.it>
##
## All lines beginning with `## DP:' are a description of the patch.
## DP: Fixed Integer overflow in the wxImage::Create function (CVE-2009-2369) (#537175)

@DPATCH@
diff -urNad wxwidgets2.8-2.8.7.1~/src/common/imagpng.cpp wxwidgets2.8-2.8.7.1/src/common/imagpng.cpp
--- wxwidgets2.8-2.8.7.1~/src/common/imagpng.cpp	2007-07-04 21:25:04.000000000 +0200
+++ wxwidgets2.8-2.8.7.1/src/common/imagpng.cpp	2009-07-29 23:04:20.000000000 +0200
@@ -566,18 +566,16 @@
     if (!image->Ok())
         goto error;
 
-    lines = (unsigned char **)malloc( (size_t)(height * sizeof(unsigned char *)) );
+    // initialize all line pointers to NULL to ensure that they can be safely
+    // free()d if an error occurs before all of them could be allocated
+    lines = (unsigned char **)calloc(height, sizeof(unsigned char *));
     if ( !lines )
         goto error;
 
     for (i = 0; i < height; i++)
     {
         if ((lines[i] = (unsigned char *)malloc( (size_t)(width * (sizeof(unsigned char) * 4)))) == NULL)
-        {
-            for ( unsigned int n = 0; n < i; n++ )
-                free( lines[n] );
             goto error;
-        }
     }
 
     png_read_image( png_ptr, lines );
diff -urNad wxwidgets2.8-2.8.7.1~/src/common/imagtiff.cpp wxwidgets2.8-2.8.7.1/src/common/imagtiff.cpp
--- wxwidgets2.8-2.8.7.1~/src/common/imagtiff.cpp	2007-09-21 22:27:05.000000000 +0200
+++ wxwidgets2.8-2.8.7.1/src/common/imagtiff.cpp	2009-07-29 23:04:20.000000000 +0200
@@ -261,7 +261,6 @@
     }
 
     uint32 w, h;
-    uint32 npixels;
     uint32 *raster;
 
     TIFFGetField( tif, TIFFTAG_IMAGEWIDTH, &w );
@@ -275,9 +274,20 @@
                            (samplesInfo[0] == EXTRASAMPLE_ASSOCALPHA ||
                             samplesInfo[0] == EXTRASAMPLE_UNASSALPHA));
 
-    npixels = w * h;
+    // guard against integer overflow during multiplication which could result
+    // in allocating a too small buffer and then overflowing it
+    const double bytesNeeded = (double)w * (double)h * sizeof(uint32);
+    if ( bytesNeeded >= 4294967295U /* UINT32_MAX */ )
+    {
+        if ( verbose )
+            wxLogError( _("TIFF: Image size is abnormally big.") );
 
-    raster = (uint32*) _TIFFmalloc( npixels * sizeof(uint32) );
+        TIFFClose(tif);
+
+        return false;
+    }
+
+    raster = (uint32*) _TIFFmalloc( bytesNeeded );
 
     if (!raster)
     {
